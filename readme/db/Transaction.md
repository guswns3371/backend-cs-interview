# Transaction

## íŠ¸ëœì­ì…˜

`íŠ¸ëœì­ì…˜`ì´ë€ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì‘ì—… ë‹¨ìœ„ì´ë‹¤.

- íŠ¸ëœì­ì…˜ì€ ë°ì´í„°ë² ì´ìŠ¤ ì—°ì‚°ë“¤ì„ ëª¨ì•„ë‘” ë‹¨ìœ„

> íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œ ì´ìœ 
> 

ë°ì´í„° ë¶€ì •í•©ì´ ë°œìƒí•  ê²½ìš° íŠ¸ëœì­ì…˜ì´ë¼ëŠ” ë…¼ë¦¬ì  ë‹¨ìœ„ ê¸°ì¤€ìœ¼ë¡œ Rollbackí•  ìˆ˜ ìˆê¸° ë•Œë¬¸

> íŠ¸ëœì­ì…˜ì€ ì‚¬ëŒì´ ì •í•œ ê¸°ì¤€ì˜ ì‘ì—…ë‹¨ìœ„ì´ë‹¤.
> 

`ì‚¬ìš©ì Aê°€ ì‚¬ìš©ì Bì—ê²Œ ë§Œì›ì„ ì†¡ê¸ˆ`

1. ì‚¬ìš©ì Aì˜ ê³„ì¢Œì—ì„œ ë§Œì›ì„ ì°¨ê° (update)
2. ì‚¬ìš©ì Bì˜ ê³„ì¢Œì— ë§Œì›ì„ ì¶”ê°€ (update)

â€œë§Œì› ì†¡ê¸ˆâ€ì´ë¼ëŠ” ì‘ì—… = `ì¶œê¸ˆ update & ì…ê¸ˆ update` = íŠ¸ëœì­ì…˜

- ë‘ update ì¿¼ë¦¬ ë¬¸ì´ ì™„ë£Œë˜ì–´ì•¼ë§Œ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ ì™„ë£Œë˜ëŠ” ê²ƒì´ë‹¤. (commit)
- ì‘ì—…ë‹¨ìœ„ì— ì†í•˜ëŠ” ì¿¼ë¦¬(ì—°ì‚°)ì´ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ í•´ë‹¹ íŠ¸ëœì­ì…˜ ì† ëª¨ë“  ì¿¼ë¦¬ë¥¼ ì·¨ì†Œí•´ì•¼ í•œë‹¤ (rollback)

> íŠ¸ëœì­ì…˜ì˜ 2ê°€ì§€ ì—°ì‚°
> 
- `Commit ì—°ì‚°` : íŠ¸ëœì­ì…˜ ì† ëª¨ë“  ì‘ì—…ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ ë°ì´í„° ë³€ê²½ ì‚¬í•­ì„ DBì— ë°˜ì˜í•˜ëŠ” ì—°ì‚°
- `Rollback ì—°ì‚°` : íŠ¸ëœì­ì…˜ ì† ì‘ì—… ì¤‘ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ë°ì´í„° ì¼ê´€ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ í˜„ì¬ íŠ¸ëœì­ì…˜ ì‹¤í–‰ ì´ì „ì˜ ìƒíƒœë¡œ ë˜ëŒë¦¬ëŠ” ì—°ì‚°

> íŠ¸ëœì­ì…˜ì˜ ìƒíƒœ
> 

![roll.png](Transactio%2099593/roll.png)

| ìƒíƒœ | ì„¤ëª… |
| --- | --- |
| í™œì„±(Active) | íŠ¸ëœì­ì…˜ì´ ì‹¤í–‰ì¤‘ì¸ ìƒíƒœ |
| ë¶€ë¶„ ì™„ë£Œ(Partially Commited) | íŠ¸ëœì­ì…˜ì˜ ë§ˆì§€ë§‰ ì—°ì‚°ê¹Œì§€ ì™„ë£Œí•˜ì˜€ê³ , commitë˜ê¸° ì§ì „ì˜ ìƒíƒœ |
| ì™„ë£Œ(Commited) | íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì–´ commitëœ ì´í›„ì˜ ìƒíƒœ |
| ì‹¤íŒ¨(Failed) | íŠ¸ëœì­ì…˜ ì‹¤í–‰ ì¤‘ê°„ì— ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ì¤‘ë‹¨ëœ ìƒíƒœ |
| ì² íšŒ(Aborted) | íŠ¸ëœì­ì…˜ì´ ë¹„ì •ìƒ ì¢…ë£Œë˜ì–´ rollback ì—°ì‚°ì„ ìˆ˜í–‰í•œ ìƒíƒœ |

## ACID

íŠ¸ëœì­ì…˜ì˜ 4ê°€ì§€ ì„±ì§ˆ

1. `Atomicity(ì›ìì„±)` : íŠ¸ëœì­ì…˜ ì—°ì‚°ì€ DBì— ëª¨ë‘ ë°˜ì˜ë˜ë“ ì§€ ì „í˜€ ë°˜ì˜ë˜ì§€ ì•Šì•„ì•¼ í•œë‹¤(All or Nothing) 
    
    â†’ `íšŒë³µ`
    
    - íŠ¸ëœì­ì…˜ ì† ëª¨ë“  ëª…ë ¹ì´ ì™„ë²½í•˜ê²Œ ìˆ˜í–‰ë˜ë©´ commitë˜ê³ , ì¤‘ê°„ì— ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ìˆ˜í–‰ ì „ìœ¼ë¡œ ëŒì•„ê°€ëŠ” rollbackì´ ìˆ˜í–‰ë˜ì–´ì•¼ Atomicityê°€ ë³´ì¥ëœë‹¤
2. `Consistency(ì¼ê´€ì„±)` : íŠ¸ëœì­ì…˜ ìˆ˜í–‰ ì „ê³¼ ì´í›„ì˜ DB ìƒíƒœê°€ ì¼ê´€ë˜ì–´ì•¼ í•œë‹¤ 
    
    â†’ `ë™ì‹œì„± ì œì–´, ë¬´ê²°ì„± ì œì•½ì¡°ê±´`
    
    - ëª…ì‹œì  ì¼ê´€ì„± : ë°ì´í„° ë¬´ê²°ì„± ì œì•½ì¡°ê±´ìœ¼ë¡œ ìœ ì§€ëœë‹¤ (ìŠ¤í‚¤ë§ˆë¥¼ í†µí•´ ì´ë¤„ì§)
    - ë¹„ëª…ì‹œì  ì¼ê´€ì„± : íŠ¸ëœì­ì…˜ ì „ê³¼ í›„ì˜ ìƒíƒœê°€ ì¼ê´€ë˜ì–´ì•¼ í•œë‹¤ (ê³„ì¢Œì´ì²´ë¥¼ ì˜ˆì‹œë¡œ ë“¤ë©´, ê³„ì¢Œ ì´ì²´ ì „ê³¼ í›„ì˜ ë‘ ê³„ì¢Œ ì”ê³ ì˜ í•©ì´ ê°™ì•„ì•¼ í•œë‹¤)
3. `Isolation(ë…ë¦½ì„±)` : ë‘˜ ì´ìƒì˜ íŠ¸ëœì­ì…˜ì´ ë™ì‹œì— ìˆ˜í–‰ë  ê²½ìš°, í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ì‹¤í–‰ ë„ì¤‘ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ ì—°ì‚°ì´ ë¼ì–´ë“¤ ìˆ˜ ì—†ë‹¤
    
    â†’ `ë™ì‹œì„± ì œì–´`
    
    - ìˆ˜í–‰ì¤‘ì¸ íŠ¸ëœì­ì…˜ì´ ì‘ì—…ì„ ì™„ë£Œí•  ë•Œê¹Œì§€ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ í•´ë‹¹ íŠ¸ëœì­ì…˜ì˜ ê²°ê³¼ë¥¼ ì°¸ì¡°í•  ìˆ˜ ì—†ë‹¤
4. `Durability(ì˜ì†ì„±)` : íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ ê·¸ ê²°ê³¼ëŠ” ì‹œìŠ¤í…œì— ì˜êµ¬ì ìœ¼ë¡œ ë°˜ì˜ë˜ì–´ì•¼ í•œë‹¤
    
    â†’ `íšŒë³µ`
    

## ë™ì‹œì„± ì œì–´

[DB ë™ì‹œì„± ì œì–´ & êµì°©ìƒíƒœ.md ì°¸ê³ ](https://github.com/guswns3371/backend-cs-interview/blob/main/DB/DB%20%EB%8F%99%EC%8B%9C%EC%84%B1%20%EC%A0%9C%EC%96%B4%20&%20%EA%B5%90%EC%B0%A9%EC%83%81%ED%83%9C.md#db--%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%A0%9C%EC%96%B4)

## íŠ¸ëœì­ì…˜ ê²©ë¦¬ìˆ˜ì¤€

`íŠ¸ëœì­ì…˜ ê²©ë¦¬ìˆ˜ì¤€(Transaction Isolation Level)`

**íŠ¸ëœì­ì…˜ì˜ ACID ì›ì¹™ì„ ì—„ê²©í•˜ê²Œ ì§€í‚¤ë ¤ë©´ ë™ì‹œì„±(Concurrency)ì´ ë§¤ìš° ë–¨ì–´ì ¸ DB ì„±ëŠ¥ì´ ë–¨ì–´ì§„ë‹¤. ë”°ë¼ì„œ DB ì„±ëŠ¥ì„ ìœ„í•´ íŠ¸ëœì­ì…˜ì˜ ì¼ê´€ì„±ì´ ì—†ëŠ” ë°ì´í„°ì— ì–´ëŠì •ë„ë¡œ ì ‘ê·¼ì„ í—ˆìš©í• ì§€ ë‚˜íƒ€ë‚´ëŠ” ìˆ˜ì¤€ì´ë‹¤.**

> ë™ì‹œì„±ê³¼ ë°ì´í„° ì¼ê´€ì„±ì€ Trade Off ê´€ê³„
> 

![Untitled](Transactio%2099593/Untitled%201.png)

ì´ Trade off ê´€ê³„ë¥¼ ì ì ˆíˆ ìœ ì§€í•˜ê¸° ìœ„í•´ íŠ¸ëœì­ì…˜ ê²©ë¦¬ìˆ˜ì¤€ì„ í™œìš©í•œë‹¤.

### `ğŸ§©Lv0. Read Uncommited`

```sql
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
```

íŠ¸ëœì­ì…˜ì´ ì²˜ë¦¬ì¤‘ì¸ ìƒíƒœì—ì„œ(commitë˜ì§€ ì•Šì€ ìƒíƒœ) ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë°ì´í„°ë¥¼ ì½ëŠ” ê²ƒì„ í—ˆìš©í•˜ëŠ” ìˆ˜ì¤€

- `Select ì¿¼ë¦¬ê°€ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ` í•´ë‹¹ ë°ì´í„°ì— S-Lockì´ ê±¸ë¦¬ì§€ ì•ŠëŠ”ë‹¤
- `Update ì¿¼ë¦¬ê°€ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ` í•´ë‹¹ ë°ì´í„°ì— X-Lockì´ ê±¸ë¦°ë‹¤
- ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ `S-Lock, X-Lock`ì´ ê±¸ë¦° ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìˆë‹¤

ë¬¸ì œì 

- `Dirty Read, Non-Repeatable Read, Phantom Read` í˜„ìƒì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

### `ğŸ§©Lv1. Read Commited`

```sql
SET TRANSACTION ISOLATION LEVEL READ COMMITTED
```

íŠ¸ëœì­ì…˜ì´ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë°ì´í„°ì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ëŠ” ìˆ˜ì¤€. commitëœ ë°ì´í„°ë§Œ ì½ì„ ìˆ˜ ìˆë‹¤

- `Select ì¿¼ë¦¬ê°€ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ` í•´ë‹¹ ë°ì´í„°ì— S-Lockì´ ê±¸ë¦°ë‹¤. Select ì¿¼ë¦¬ê°€ ì¢…ë£Œë˜ë©´ S-Lockì´ ë°”ë¡œ í•´ì œëœë‹¤.
- `Update ì¿¼ë¦¬ê°€ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ` í•´ë‹¹ ë°ì´í„°ì— X-Lockì´ ê±¸ë¦°ë‹¤
- ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ `S-Lock`ì´ ê±¸ë¦° ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìˆì§€ë§Œ `X-Lock`ì´ ê±¸ë¦° ë°ì´í„°ëŠ” ì½ì§€ ëª»í•œë‹¤.
    
    > ğŸ“ ê°±ì‹ ë˜ëŠ” ë°ì´í„°ì— X-Lockì´ ê±¸ë ¤ìˆê³ , X-Lockì´ ê±¸ë¦° ë°ì´í„°ë¥¼ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ì½ì§€ ëª»í•œë‹¤ â†’ **Dirty Read ë¬¸ì œ í•´ê²°**
    
    
- ëŒ€ë¶€ë¶„ì˜ DBMSì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì±„íƒí•˜ê³  ìˆëŠ” ê²©ë¦¬ìˆ˜ì¤€ì´ë‹¤.
    - MySQL(InnoDB), Orcale : Lockì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì¿¼ë¦¬ ì‹œì‘ ì‹œì ì˜ Undo ë°ì´í„°ë¥¼ ì œê³µí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•œë‹¤

ë¬¸ì œì 

- `Non-Repeatable Read, Phantom Read` í˜„ìƒì€ ì—¬ì „íˆ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

### `ğŸ§©Lv2. Repeatable Read`

```sql
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
```

íŠ¸ëœì­ì…˜ì´ ì ‘ê·¼í•˜ëŠ” ë°ì´í„° ë‚´ìš©ì´ í•­ìƒ ë™ì¼í•¨ì„ ë³´ì¥í•˜ëŠ” ê²©ë¦¬ ìˆ˜ì¤€

- `Select ì¿¼ë¦¬ê°€ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ` í•´ë‹¹ ë°ì´í„°ì— S-Lockì´ ê±¸ë¦¬ê³  íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë  ë•Œê¹Œì§€ ìœ ì§€ëœë‹¤
- `Update ì¿¼ë¦¬ê°€ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ` í•´ë‹¹ ë°ì´í„°ì— X-Lockì´ ê±¸ë¦°ë‹¤
- ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ `S-Lock`ì´ ê±¸ë¦° ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìˆì§€ë§Œ `X-Lock`ì´ ê±¸ë¦° ë°ì´í„°ëŠ” ì½ì§€ ëª»í•œë‹¤.
    
    >ğŸ“ íŠ¸ëœì­ì…˜ì´ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ ë°ì´í„°ì— ì„¤ì •ëœ S-Lockì´ ì¢…ë£Œë  ë•Œê¹Œì§€ ìœ ì§€ë˜ë¯€ë¡œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œ í•´ë‹¹ ë°ì´í„°ë¥¼ update(ì“°ê¸°)í•  ìˆ˜ ì—†ë‹¤ â†’ **Non-Repeatable Read ë¬¸ì œë¥¼ í•´ê²°**
    
    
- MySQL ì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì±„íƒí•˜ê³  ìˆëŠ” ê²©ë¦¬ ìˆ˜ì¤€ì´ë‹¤.

ë¬¸ì œì 

- `Phantom Read` í˜„ìƒì€ ì—¬ì „íˆ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

### `ğŸ§©Lv3. Serializable`

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
```

ì™„ë²½í•œ ì½ê¸° ì¼ê´€ì„±ì„ ì œê³µí•˜ë©° íŠ¸ëœì­ì…˜ì´ ì ‘ê·¼í•˜ëŠ” ë°ì´í„°ì— ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ìˆ˜ì •, ì…ë ¥í•  ìˆ˜ ì—†ëŠ” ìˆ˜ì¤€

- `Select ì¿¼ë¦¬ê°€ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ` í•´ë‹¹ ë°ì´í„°ì— S-Lockì´ ê±¸ë¦¬ê³  íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë  ë•Œê¹Œì§€ ìœ ì§€ëœë‹¤
- `Update ì¿¼ë¦¬ê°€ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ` í•´ë‹¹ ë°ì´í„°ì— X-Lockì´ ê±¸ë¦°ë‹¤
- ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ `S-Lock`ì´ ê±¸ë¦° ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìˆì§€ë§Œ `X-Lock`ì´ ê±¸ë¦° ë°ì´í„°ëŠ” ì½ì§€ ëª»í•œë‹¤.
- `í…Œì´ë¸” ì¸ë±ìŠ¤ì— S-Lockì„ ì„¤ì •í•˜ì—¬ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ Insert ë¬¸ì´ ê¸ˆì§€ëœë‹¤`
    
    > ğŸ“ íŠ¸ëœì­ì…˜ì´ ìˆ˜í–‰ë˜ëŠ” ë™ì•ˆ í•´ë‹¹ í…Œì´ë¸”ì— ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ Insert ë¬¸ì´ ê¸ˆì§€ëœë‹¤ â†’ **Phantom Read ë¬¸ì œë¥¼ í•´ê²°**
    
    
- ì œí•œì´ ê°€ì¥ ì‹¬í•˜ê³  ë™ì‹œì„±ë„ ë§¤ìš° ë‚®ì•„ DB ì„±ëŠ¥ì´ ì¢‹ì§€ ì•Šë‹¤. DBMSì—ì„œ ê±°ì˜ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.

[https://suhwan.dev/2019/06/09/transaction-isolation-level-and-lock/](https://suhwan.dev/2019/06/09/transaction-isolation-level-and-lock/)
